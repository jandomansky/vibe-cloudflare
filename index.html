<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Metrostav Vision</title>
</head>
<body>
  <h1>Metrostav Vision â€“ objekty z fotky ðŸ“¸</h1>

  <input id="file" type="file" accept="image/*">
  <button id="go">Analyzovat</button>

  <p id="status"></p>
  <pre id="out"></pre>

  <script>
    const statusEl = document.getElementById("status");
    const out = document.getElementById("out");

    document.getElementById("go").addEventListener("click", async () => {
      const f = document.getElementById("file").files?.[0];
      if (!f) { statusEl.textContent = "Vyber fotku."; return; }

      statusEl.textContent = "ZmenÅ¡uju fotku a odesÃ­lÃ¡mâ€¦";
      out.textContent = "";

      // doporuÄenÃ©: zmenÅ¡it v prohlÃ­Å¾eÄi, aÅ¥ nenarÃ¡Å¾Ã­Å¡ na limity
      const resized = await resizeImage(f, 1600, 0.85);

      const fd = new FormData();
      fd.append("file", resized, resized.name);

      statusEl.textContent = "AI analyzujeâ€¦";
      const r = await fetch("/api/objects", { method: "POST", body: fd });
      const data = await r.json();

      statusEl.textContent = r.ok ? "Hotovo âœ…" : "Chyba âŒ";
      out.textContent = JSON.stringify(data, null, 2);
    });

    async function resizeImage(file, maxSide, quality) {
      const img = await fileToImage(file);
      const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      c.getContext("2d").drawImage(img, 0, 0, w, h);

      const blob = await new Promise((res) => c.toBlob(res, "image/jpeg", quality));
      return new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", { type: "image/jpeg" });
    }

    function fileToImage(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = reject;
        img.src = url;
      });
    }
  </script>
</body>
</html>
