<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metrostav Vision</title>
</head>

<body>
  <h1>Metrostav Vision â€“ objekty z fotky ðŸ“¸</h1>

  <input id="file" type="file" accept="image/*" />
  <button id="go">Analyzovat</button>

  <p id="status"></p>
  <pre id="out" style="white-space: pre-wrap;"></pre>

  <script>
    const statusEl = document.getElementById("status");
    const out = document.getElementById("out");

    document.getElementById("go").addEventListener("click", async () => {
      try {
        const f = document.getElementById("file").files?.[0];
        if (!f) {
          statusEl.textContent = "Vyber fotku.";
          return;
        }

        statusEl.textContent = "PÅ™evÃ¡dÃ­m fotku na JPEG a zmenÅ¡ujiâ€¦";
        out.textContent = "";

        // âœ… vÅ¾dy vytvoÅ™Ã­me "ÄistÃ½" JPEG
        const resizedJpeg = await fileToCleanJpeg(f, 1600, 0.85);

        const fd = new FormData();
        fd.append("file", resizedJpeg, resizedJpeg.name);

        statusEl.textContent = "AI analyzujeâ€¦";
        const r = await fetch("/api/objects", { method: "POST", body: fd });

        // âœ… nejdÅ™Ã­v text, abychom zvlÃ¡dli i HTML error page
        const text = await r.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { ok: false, error: "Non-JSON response", raw: text };
        }

        statusEl.textContent = r.ok ? "Hotovo âœ…" : `Chyba ${r.status} âŒ`;
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        statusEl.textContent = "Spadlo to v prohlÃ­Å¾eÄi âŒ";
        out.textContent = String(e);
        console.error(e);
      }
    });

    // --- Helpers ---

    async function fileToCleanJpeg(file, maxSide, quality) {
      const img = await fileToImage(file);

      const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);

      const c = document.createElement("canvas");
      c.width = w;
      c.height = h;

      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      const blob = await new Promise((resolve) => c.toBlob(resolve, "image/jpeg", quality));

      // âœ… dÅ¯leÅ¾itÃ©: toBlob mÅ¯Å¾e vrÃ¡tit null
      if (!blob) throw new Error("NepodaÅ™ilo se pÅ™evÃ©st obrÃ¡zek na JPEG (canvas.toBlob returned null).");

      const base = (file.name || "photo").replace(/\.[^.]+$/, "");
      return new File([blob], base + ".jpg", { type: "image/jpeg" });
    }

    function fileToImage(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = (err) => {
          URL.revokeObjectURL(url);
          reject(err);
        };
        img.src = url;
      });
    }
  </script>
</body>
</html>
